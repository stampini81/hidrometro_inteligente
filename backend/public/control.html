<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Controle do Hidrômetro</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;background:#f7f9fc;margin:0;padding:20px}
    .card{background:white;border-radius:8px;padding:20px;box-shadow:0 6px 18px rgba(0,0,0,.08);max-width:720px;margin:20px auto}
    .grid{display:grid;grid-template-columns:1fr 1fr;gap:16px}
    .value{font-size:26px;color:#1976d2}
    button{padding:10px 16px;border:0;border-radius:6px;background:#1976d2;color:#fff;cursor:pointer}
    input{padding:8px 10px;border:1px solid #ccd;border-radius:6px}
    .row{display:flex;gap:8px;align-items:center}
  </style>
</head>
<body>
  <div class="card">
    <h2>Controle do Hidrômetro</h2>
    <div class="grid">
      <div>
        <strong>Total (L)</strong>
        <div id="total" class="value">0.0</div>
      </div>
      <div>
        <strong>Vazão (L/min)</strong>
        <div id="flow" class="value">0.0</div>
      </div>
    </div>
    <hr>
    <div class="row">
      <button id="btnReset">Resetar Consumo</button>
    </div>
    <div class="row" style="margin-top:10px">
      <input id="calVal" placeholder="Novo fator de calibração" type="number" step="0.1">
      <button id="btnCal">Aplicar Calibração</button>
    </div>
    <hr>
    <h3>Simulação</h3>
    <div class="row">
      <input id="simFlow" placeholder="Fluxo simulado (L/min)" type="number" step="0.1" value="8">
      <button id="btnSimOn">Iniciar Simulação</button>
      <button id="btnSimSet">Ajustar Fluxo</button>
      <button id="btnSimOff">Parar Simulação</button>
    </div>
    <p id="status"></p>
  </div>
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
  <script>
    const api = (path, opts={}) => fetch(path, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(opts.body||{})}).then(r=>r.json());
    function render(j){
      if(!j) return;
      const total = (j.totalLiters ?? j.total ?? 0);
      const flow = (j.flowLmin ?? j.flowRate ?? 0);
      document.getElementById('total').textContent = Number(total).toFixed(1);
      document.getElementById('flow').textContent = Number(flow).toFixed(1);
    }
    const socket = io();
    socket.on('data', render);

    document.getElementById('btnReset').onclick = async () => {
      const res = await api('/api/cmd', { body: { action: 'reset' }});
      document.getElementById('status').textContent = 'Reset enviado.';
    };
    document.getElementById('btnCal').onclick = async () => {
      const v = parseFloat(document.getElementById('calVal').value);
      if (!v || v <= 0) { alert('Informe um valor válido'); return; }
      const res = await api('/api/cmd', { body: { action: 'setCalibration', value: v }});
      document.getElementById('status').textContent = 'Calibração enviada: ' + v;
    };
    // Simulação
    document.getElementById('btnSimOn').onclick = async () => {
      const v = parseFloat(document.getElementById('simFlow').value) || 8;
      await api('/api/cmd', { body: { action: 'simulate', value: v }});
      document.getElementById('status').textContent = 'Simulação iniciada em ' + v + ' L/min';
    };
    document.getElementById('btnSimSet').onclick = async () => {
      const v = parseFloat(document.getElementById('simFlow').value) || 8;
      await api('/api/cmd', { body: { action: 'simSetFlow', value: v }});
      document.getElementById('status').textContent = 'Fluxo simulado ajustado para ' + v + ' L/min';
    };
    document.getElementById('btnSimOff').onclick = async () => {
      await api('/api/cmd', { body: { action: 'simOff' }});
      document.getElementById('status').textContent = 'Simulação parada';
    };
  </script>
</body>
</html>
