{% extends 'base.html' %}
{% block content %}
<h2>Tempo Real - {{ cliente.nome }}</h2>
<div id="devices" class="card" style="padding:1rem;background:#fff;border-radius:8px;box-shadow:0 2px 6px rgba(0,0,0,.1);">
  <div id="status" style="margin-bottom:1rem;font-size:0.9rem;color:#555;">Conectando...</div>
  <div style="display:flex;align-items:center;gap:.5rem;margin-bottom:.5rem;flex-wrap:wrap;">
    <button id="btnClearAlerts" style="background:#555;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;">Limpar Alertas</button>
    <button id="btnReloadAlerts" style="background:#1976d2;color:#fff;border:none;padding:6px 10px;border-radius:4px;cursor:pointer;font-size:.8rem;">Recarregar Alertas</button>
    <span style="font-size:.75rem;color:#666;">(persistidos no banco e exibidos abaixo)</span>
  </div>
  <div id="alerts" style="margin-bottom:1rem;"></div>
  <table style="width:100%;border-collapse:collapse;">
    <thead>
      <tr style="text-align:left;border-bottom:2px solid #ddd;">
        <th>Dispositivo</th>
        <th>Total (L)</th>
        <th>Vazão (L/min)</th>
        <th>Atualizado</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
</div>
<!-- Carrega socket.io via CDN. Se ainda tentar buscar /socket.io/socket.io.js (cache antigo), força fallback -->
<script>
if(!window.io){
  const s=document.createElement('script');
  s.src='https://cdn.socket.io/4.7.5/socket.io.min.js';
  s.crossOrigin='anonymous';
  s.referrerPolicy='no-referrer';
  s.onload=()=>{ console.log('[tempo-real] socket.io CDN carregado'); initAfterSocket(); };
  s.onerror=()=>{ console.error('[tempo-real] Falha ao carregar socket.io CDN'); };
  document.head.appendChild(s);
} else {
  initAfterSocket();
}
</script>
<script>
const clienteId = parseInt("{{ cliente.id_cliente }}", 10);
const tbody = document.getElementById('tbody');
const statusEl = document.getElementById('status');
let socket = null; // será inicializado após carregamento do script socket.io
let dispositivos = {}; // key: numero_serie
let alertsDiv = document.getElementById('alerts');
function alertElement(a){
  const el = document.createElement('div');
  el.style.background = a.resolved_at ? '#2e7d32' : '#c62828';
  el.style.color = '#fff';
  el.style.padding = '6px 10px';
  el.style.borderRadius = '4px';
  el.style.marginBottom = '4px';
  el.style.fontSize = '0.75rem';
  el.style.display='flex';
  el.style.justifyContent='space-between';
  el.style.alignItems='center';
  const span = document.createElement('span');
  span.textContent = `[${a.serial||'-'}] ${a.message}`;
  el.appendChild(span);
  if(!a.resolved_at){
    const btn = document.createElement('button');
    btn.textContent='Resolver';
    btn.style.background='rgba(255,255,255,.15)';
    btn.style.color='#fff';
    btn.style.border='none';
    btn.style.padding='4px 8px';
    btn.style.borderRadius='4px';
    btn.style.cursor='pointer';
    btn.onclick = async()=>{
      try{ const r= await fetch(`/api/alerts/${a.id}/resolve`, {method:'POST'}); if(r.ok){ await carregarAlertas(); } }catch(e){console.error(e);} };
    el.appendChild(btn);
  }
  return el;
}
function pushAlertObj(a){
  const el = alertElement(a);
  alertsDiv.prepend(el);
  while(alertsDiv.children.length>20){ alertsDiv.removeChild(alertsDiv.lastChild); }
}
function pushAlertText(text){
  pushAlertObj({message:text, serial: '', id: 'temp-'+Date.now()});
}

function render(){
  tbody.innerHTML = Object.values(dispositivos).map(d => {
    return `<tr style="border-bottom:1px solid #eee;">
      <td>${d.numero_serie || '(sem serial)'}</td>
      <td>${d.totalLiters?.toFixed ? d.totalLiters.toFixed(2) : '-'}</td>
      <td>${d.flowLmin?.toFixed ? d.flowLmin.toFixed(2) : '-'}</td>
      <td>${d.updated ? new Date(d.updated).toLocaleTimeString() : '-'}</td>
    </tr>`
  }).join('');
}

async function carregarIniciais(){
  try {
    const r = await fetch(`/api/clientes/${clienteId}/dispositivos/current`);
    if(!r.ok) return;
    const data = await r.json();
    (data.dispositivos||[]).forEach(d => {
      dispositivos[d.numero_serie] = {
        numero_serie: d.numero_serie,
        totalLiters: d.ultima_leitura?.total_liters || 0,
        flowLmin: d.ultima_leitura?.flow_lmin || 0,
        updated: d.ultima_leitura?.data_hora
      };
    });
    render();
  } catch(e){ console.error(e); }
}

function startRealtime(){
  try {
    socket = io({ transports:['websocket','polling'], timeout:5000 });
  } catch(e){ console.error('Erro inicializando io()', e); statusEl.textContent='Erro inicializando socket'; return; }
  socket.on('connect', ()=> { statusEl.textContent='Conectado'; });
  socket.on('connect_error', (err)=> { console.error('connect_error', err); statusEl.textContent='Falha conexão'; });
  socket.on('disconnect', (r)=> { statusEl.textContent='Desconectado ('+r+')'; });
  socket.on('reconnect_attempt', (n)=> { statusEl.textContent='Reconectando ('+n+')'; });
  socket.on('data', payloadHandler);
  socket.on('alert', alertHandler);
}

function payloadHandler(payload){
  const serial = (payload.numero_serie||'').toUpperCase();
  if(!serial) return;
  if(!dispositivos[serial]){ dispositivos[serial] = { numero_serie: serial }; }
  dispositivos[serial].totalLiters = payload.totalLiters;
  dispositivos[serial].flowLmin = payload.flowLmin;
  dispositivos[serial].updated = Date.now();
  render();
}
function alertHandler(a){ if(a.type==='leak'){ pushAlertObj(a); }}



async function carregarAlertas(){
  try{
  const r = await fetch('/api/alerts?limit=50');
  if(!r.ok) { return; }
  const data = await r.json();
    alertsDiv.innerHTML='';
    (data.alerts||[]).forEach(a=> alertsDiv.appendChild(alertElement(a)) );
  }catch(e){console.error(e);}
}

document.getElementById('btnClearAlerts').onclick = async()=>{
  try{ await fetch('/api/alerts/clear-temporary',{method:'POST'}); }catch(e){console.error(e);}finally{ /* somente limpa estado em memória */ }
};
document.getElementById('btnReloadAlerts').onclick = ()=>carregarAlertas();

function initAfterSocket(){
  try{ console.log('[tempo-real] window.io presente?', !!window.io); }catch(e){}
  carregarIniciais();
  carregarAlertas();
  // Só inicia se io realmente carregado
  if(window.io){ startRealtime(); }
  else { statusEl.textContent='socket.io não carregado'; }
}

// Se script CDN adicionou-se acima, initAfterSocket será chamado no onload. Caso io já existisse, já chamamos também.
</script>
{% endblock %}
