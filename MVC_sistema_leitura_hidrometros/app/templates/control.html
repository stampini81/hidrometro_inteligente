{% extends 'base.html' %}
{% block content %}
<div class="card">
  <h2>Controle do Hidrômetro</h2>
  <div class="grid" style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
    <div>
      <strong>Total (L)</strong>
      <div id="total" class="value">0.0</div>
    </div>
    <div>
      <strong>Vazão (L/min)</strong>
      <div id="flow" class="value">0.0</div>
    </div>
  </div>
  <hr>
  <div class="row" style="display:flex;gap:8px;align-items:center">
    <button id="btnReset">Resetar Consumo</button>
  </div>
  <div class="row" style="margin-top:10px;display:flex;gap:8px;align-items:center">
    <input id="calVal" placeholder="Novo fator de calibração" type="number" step="0.1">
    <button id="btnCal">Aplicar Calibração</button>
  </div>
  <hr>
  <h3>Simulação</h3>
  <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
    <input id="simFlow" placeholder="Fluxo simulado (L/min)" type="number" step="0.1" value="8">
    <button id="btnSimOn">Iniciar Simulação</button>
    <button id="btnSimSet">Ajustar Fluxo</button>
    <button id="btnSimOff">Parar Simulação</button>
  </div>
  <p id="status"></p>
</div>
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"></script>
<script>
  const api = (path, opts={}) => fetch(path, {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(opts.body||{})}).then(r=>r.json());
  function render(j){ if(!j) return; const total=(j.totalLiters??j.total??0); const flow=(j.flowLmin??j.flowRate??0); document.getElementById('total').textContent=Number(total).toFixed(1); document.getElementById('flow').textContent=Number(flow).toFixed(1); }
  const socket = io(); socket.on('data', render);
  btnReset.onclick = async ()=>{ await api('/api/cmd',{body:{action:'reset'}}); status.textContent='Reset enviado.'; };
  btnCal.onclick = async ()=>{ const v=parseFloat(calVal.value); if(!v||v<=0){alert('Informe um valor válido');return;} await api('/api/cmd',{body:{action:'setCalibration', value:v}}); status.textContent='Calibração enviada: '+v; };
  btnSimOn.onclick = async ()=>{ const v=parseFloat(simFlow.value)||8; await api('/api/cmd',{body:{action:'simulate', value:v}}); status.textContent='Simulação iniciada em '+v+' L/min'; };
  btnSimSet.onclick = async ()=>{ const v=parseFloat(simFlow.value)||8; await api('/api/cmd',{body:{action:'simSetFlow', value:v}}); status.textContent='Fluxo simulado ajustado para '+v+' L/min'; };
  btnSimOff.onclick = async ()=>{ await api('/api/cmd',{body:{action:'simOff'}}); status.textContent='Simulação parada'; };
</script>
{% endblock %}
